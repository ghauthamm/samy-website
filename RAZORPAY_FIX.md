# Razorpay Integration - Issue Fixed ✅

## Issue: 400 Bad Request Error

**Error Message:**
```
Failed to load resource: the server responded with a status of 400 (Bad Request)
api.razorpay.com/v1/standard_checkout/preferences?...&order_id=order_1770617102302_5zl8no216
```

### Root Cause
The 400 error was occurring because we were passing a **mock `order_id`** that wasn't created through Razorpay's Orders API. Razorpay validates the `order_id` and rejects any ID that wasn't generated by their system.

### Solution Applied ✅

**1. Made `order_id` Optional**
- Updated `razorpay.js` to not require `order_id` parameter
- Razorpay allows payments without `order_id` in test mode
- This enables immediate testing without backend setup

**2. Updated Payment Flow**
```javascript
// Before (causing 400 error):
const orderId = `order_${Date.now()}_${random}`;  // Mock ID - Rejected by Razorpay ❌
options.order_id = orderId;

// After (working solution):
// No order_id passed - Razorpay accepts this ✅
// Payment works without backend order creation
```

**3. Files Modified**
- ✅ `src/utils/razorpay.js` - Removed mandatory order_id requirement
- ✅ `src/pages/Checkout/CheckoutPage.jsx` - Stopped generating mock order_id

### Current Behavior

**Test Mode (Current):**
- ✅ Payments work without `order_id`
- ✅ Razorpay generates payment_id
- ✅ Order saved to Firebase with payment details
- ✅ No 400 errors

**How It Works Now:**
1. User clicks "Place Order"
2. Razorpay modal opens (NO order_id sent)
3. User completes payment
4. Payment successful → `razorpay_payment_id` returned
5. Order saved with payment_id as reference
6. ✅ Success page displayed

### For Production (Future)

When deploying to production, you should:

**Step 1: Create Backend Endpoint**
```javascript
// Backend API (Node.js example)
app.post('/api/create-razorpay-order', async (req, res) => {
    const { amount, currency } = req.body;
    
    const razorpay = new Razorpay({
        key_id: process.env.RAZORPAY_KEY_ID,
        key_secret: process.env.RAZORPAY_KEY_SECRET
    });
    
    const options = {
        amount: amount * 100,  // paise
        currency: currency || 'INR',
        receipt: `receipt_${Date.now()}`
    };
    
    try {
        const order = await razorpay.orders.create(options);
        res.json({ orderId: order.id });
    } catch (error) {
        res.status(500).json({ error: error.message });
    }
});
```

**Step 2: Update Frontend**
```javascript
// CheckoutPage.jsx
const response = await fetch('/api/create-razorpay-order', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ amount: total, currency: 'INR' })
});

const { orderId } = await response.json();

await initiatePayment({
    amount: total,
    orderId: orderId,  // Real Razorpay order_id from backend
    // ... other details
});
```

**Step 3: Verify Payment**
```javascript
// Backend webhook or verification endpoint
app.post('/api/verify-payment', (req, res) => {
    const { orderId, paymentId, signature } = req.body;
    
    const text = orderId + '|' + paymentId;
    const generated = crypto
        .createHmac('sha256', process.env.RAZORPAY_KEY_SECRET)
        .update(text)
        .digest('hex');
    
    if (generated === signature) {
        // Payment verified - Update order status
        res.json({ verified: true });
    } else {
        res.status(400).json({ error: 'Invalid signature' });
    }
});
```

### Benefits of Current Approach

**Advantages:**
- ✅ Works immediately without backend
- ✅ Perfect for testing and development
- ✅ No additional setup required
- ✅ All Razorpay features available (UPI, cards, etc.)

**Limitations:**
- ⚠️ No server-side order amount verification
- ⚠️ Manual reconciliation needed
- ⚠️ Not recommended for production

### Testing Steps

1. **Navigate to checkout**
   ```
   http://localhost:5173/checkout
   ```

2. **Fill in the form with test data**

3. **Select Razorpay payment**

4. **Click "Place Order"**

5. **Use test card:**
   - Card: `4111 1111 1111 1111`
   - CVV: Any 3 digits
   - Expiry: Any future date

6. **Complete payment**

7. **✅ Success! No 400 error**

### Debug Information

If you still see issues, check:

**Console Logs:**
```javascript
// Should NOT see:
❌ "400 Bad Request"
❌ "Invalid order_id"

// Should see:
✅ "Razorpay SDK loaded successfully"
✅ "Payment successful" (after payment)
```

**Network Tab:**
- Razorpay API calls should return 200 OK
- No requests with mock order_id in parameters

**Firebase Database:**
- Orders should be saved with `paymentId`
- `orderId` will use `RZP_${paymentId}` format

### Summary

The integration now works perfectly in test mode! The 400 error has been resolved by removing the mock order_id requirement. For production deployment, follow the "For Production" steps above to implement proper backend order creation and verification.

---

**Status**: ✅ Fixed and Working
**Date**: February 9, 2026
**Impact**: Can now test full payment flow without errors
